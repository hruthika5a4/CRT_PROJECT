{% extends 'report/main.html' %}
{% load static %}
{% block content %}

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#">MTIEAT</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item active">
          <a class="nav-link" href="#">Admin Dashboard <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'user_profile' user_email=email %}">Profile</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{% url 'report_table' %}">Lesson Plan Report</a>
        </li>
        <form action="{% url 'logout' %}" method="post">
            {% csrf_token %}
            <button type="submit">Log Out</button>
          </form>
        

      </ul>
    </div>
  </nav>
<br>
<div class="row">
    <div class="col">
        <div class="col-md">
            <div class="card text-center text-white mb-3" id="total-orders">
                <div class="card-header">
                    <h5 class="card-title"><a href="{% url 'faculty_list' %}">View Teachers</a>
                    </h5>
                </div>
                <div class="card-body">
                    <h3 class="card-title">{{ total_users_count }}</h3>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="col-md">
            <div class="card text-center text-white mb-3" id="orders-delivered">

                <div class="card-header">
                    <h5 class="card-title"><a href="{% url 'lesson_plan_list' %}">View Lesson Plans Taken</a></h5>
                </div>
                <div class="card-body">
                    <h3 class="card-title">{{ total_lesson_plans_count }}</h3>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="col-md">
            <div class="card text-center text-white mb-3" id="orders-pending">
                <div class="card-header">
                    <h5 class="card-title"><a href="{% url 'topic_list' %}">View Topics Taken</a></h5>
                </div>
                <div class="card-body">
                    <h3 class="card-title">{{ total_topics_count }}</h3>
                </div>
            </div>
        </div>
    </div>
</div>
<br>

<div class="row">
    <div class="col">
        <div class="card card-body">

            <form method="get" class="form-inline">
                {% for field in myFilter.form %}
                <div class="form-group">
                    {{ field.label_tag }}
                    {{ field }}
                </div>
                {% endfor %}
                {% for field in filtered_Topics.form %}
                <div class="form-group">
                    {{ field.label_tag }}
                    {{ field }}
                </div>
                {% endfor %}
                <button class="btn btn-primary" type="submit">Search</button>
            </form>
        </div>
    </div>
</div>

<br>
<!-- <button id="exportBtn" class="btn btn-primary">Export to Excel</button> -->
<button id="exportToPDF" class="btn btn-primary">Export to PDF</button>

<br>

<div class="row" id="export_element">
    <div class="col-md">
        <div class="card card-body">
            <table id="topicTable" class="table table-bordered table-sm">
                <thead class="thead-dark">
                    <tr>
                        <th>Faculty</th>
                        <th>Lesson Plan</th>
                        <th>Branch</th>
                        <th>Sem</th>
                        <th class="text-center">Topic</th>

                    </tr>
                </thead>
                <tbody>
                    {% for lesson_plan in lesson_plan_details %}
                    <tr>
                        <td>{{ lesson_plan.faculty}}</td>
                        <td>{{ lesson_plan.name }}</td>
                        <td>{{ lesson_plan.dept }}</td>
                        <td>{{ lesson_plan.sem }}</td>
                        <td>
                            <table id="topicTable1" class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Topic</th>
                                        <th>Target Date</th>
                                        <th>Status</th>
                                        <th>Remark</th>
                                        <th>Update</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for topic in lesson_plan.topics %}
                                    <tr data-topic-id="{{ topic.topic_id }}">
                                        <td>{{ topic.topic_name }}</td>
                                        <td>{{ topic.target_date }}</td>
                                        <td class="editable" data-field="status" id="status-{{ topicId }}">{{topic.status }}</td>
                                        <td class="editable" data-field="remarks" id="remarks-{{ topicId }}">{{topic.remarks }}</td>
                                        <td>
                                            <button class="update-btn btn btn-primary"
                                                data-topic-id="{{ topic.topic_id }}">Update</button>
                                        </td>
                                    </tr>
                                    {% endfor %}

                                </tbody>
                            </table>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.0/html2pdf.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
    var choices = {
        dept: [
            ['Civil', 'civil'], ['Mechanical', 'mech'], ['EEE', 'eee'],
            ['ECE', 'ece'], ['CSE', 'cse'], ['AI&DS', 'ai_ds'],
            ['DS', 'ds'], ['CRT', 'crt'], ['H&S', 'hns']
        ],
        sem: [
            ['I-I', '1-1'], ['I-II', '1-2'], ['II-I', '2-1'],
            ['II-II', '2-2'], ['III-I', '3-1'], ['III-II', '3-2'],
            ['IV-I', '4-1'], ['IV-II', '4-2']
        ],
        status: [['CO', 'co'], ['NS', 'ns']]
    };
</script>
<script>
     $(document).ready(function () {
        // Function to handle updating a topic
        $('.update-btn').click(function () {
            var row = $(this).closest('tr');
            var topicId = row.data('topic-id');

            row.find('.editable').each(function () {
                var value = $(this).text();
                var field = $(this).data('field');
                var inputElement;

                if (field === 'target_date') {
                    // Convert the date value to YYYY-MM-DD format
                    var date = new Date(value);
                    var year = date.getFullYear();
                    var month = ('0' + (date.getMonth() + 1)).slice(-2);
                    var day = ('0' + date.getDate()).slice(-2);
                    var formattedDate = year + '-' + month + '-' + day;
                    // Create date input field for 'target_date'
                    inputElement = '<input type="date" class="form-control" value="' + value + '" id="' + field + '-' + topicId + '">';
                } else if (field in choices) {
                    // Create dropdown for choices
                    inputElement = '<select class="form-control" id="' + field + '-' + topicId + '">';
                    choices[field].forEach(function (option) {
                        var selected = (option[1] === value) ? 'selected' : '';
                        inputElement += '<option value="' + option[1] + '" ' + selected + '>' + option[0] + '</option>';
                    });
                    inputElement += '</select>';
                } else {
                    // Create input field for non-choices
                    inputElement = '<input type="text" class="form-control" value="' + value + '" id="' + field + '-' + topicId + '">';
                }

                $(this).html(inputElement);
            });

            // Replace 'Update' button with 'Save' button
            $(this).replaceWith('<button class="save-btn btn btn-success" onclick="saveTopic(' + topicId + ')">Save</button>');
        });
    });

    // Function to save lesson plan information
    function saveTopic(topicId) {
        // Retrieve values using document.getElementById or jQuery as needed
        var status = document.getElementById('status-' + topicId).value;
        var remarks = document.getElementById('remarks-' + topicId).value;
        // Add more fields as needed

        // Prepare request data
        var requestData = {
            status: encodeURIComponent(status),
            remarks: encodeURIComponent(remarks)
            // Add more fields as needed
        };

        // Log request data to console
        console.log('Request Data:', requestData);

        // Perform an AJAX request to update lesson plan information
        fetch(`/report/update-topic1/${topicId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: Object.keys(requestData).map(key => key + '=' + requestData[key]).join('&')
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response Data:', data);
                if (data.success) {
                    // Optionally, update the UI or provide feedback to the user
                    alert('Topic information updated successfully!');

                    // Disable input fields
                    var row = $('#topic-table tr[data-topic-id="' + topicId + '"]');
                    row.find('.editable').each(function () {
                        var value = $(this).find(':input').val();
                        $(this).text(value);
                    });

                    // Change button back to 'Update'
                    location.reload();
                } else if (data.errors) {
                    // Handle validation errors if any
                    console.error('Validation Errors:', data.errors);
                    alert('Error updating topic information. Please check the form data.');
                } 
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
                alert('Error updating topic information');
            });
    }

    // Function to get CSRF token from cookies
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Your JavaScript code here
        // Your JavaScript code here
document.getElementById('exportToPDF').addEventListener('click', function () {
    // Set the options for html2pdf
    var options = {
        margin: 15,
        filename: 'exported_document.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
    };
    var targetElement = document.getElementById('export_element');
    // Use html2pdf to export the entire page
    html2pdf(targetElement, options);
});

    });

</script>

{% endblock %}